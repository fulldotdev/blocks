---
import { getCollection, getEntries } from 'astro:content'
import { mapKeys } from 'radash'

interface Props {
  _bookshop_name?: string
  [key: string | number | symbol]: any
}

let { _bookshop_name, records, pages, source, ...rest } = Astro.props

const packageBlocks = import.meta.glob('../blocks/**/*.astro')
const userBlocks = import.meta.glob('/src/blocks/**/*.astro')

const mapBlockKeys = (blocks: any) =>
  mapKeys(blocks, (key: any) => key.split('/').pop().split('.').shift())

const components = {
  ...mapBlockKeys(packageBlocks),
  ...mapBlockKeys(userBlocks),
}

const found = components[_bookshop_name as any] as any
const functioncomp = found && (await found())
const Component = functioncomp?.default

records = records
  ? (await getEntries(records)).map((entry: any) => entry?.data)
  : undefined

pages = pages
  ? (await getEntries(pages)).map((entry: any) => ({
      href: `/${entry.slug}/`,
      ...entry?.data,
    }))
  : undefined

const slug = Astro.url.pathname.replace(/^\/|\/$/g, '')

const children =
  source === 'children' && slug
    ? [
        ...(
          await getCollection(
            'pages',
            (page) =>
              page.slug.startsWith(slug) &&
              page.slug !== slug &&
              !page.slug.replace(`${slug}/`, '').includes('/')
          )
        ).map((page) => ({ href: `/${page.slug}/`, ...page.data })),
        ...(
          await getCollection(
            'records',
            (record) =>
              record.id.startsWith(slug) &&
              record.id !== slug &&
              !record.id.replace(`${slug}/`, '').includes('/')
          )
        ).map((record) => record.data),
      ]
    : undefined

const references =
  source === 'references' && slug
    ? (
        await getCollection('pages', (page) =>
          page.data?.pages?.find(
            (page) =>
              page.slug
                .replace('.md', '')
                .replace('/index', '')
                .replace('src/content/', '') === slug
          )
        )
      ).map((item) => ({ href: `/${item.slug}/`, ...item.data }))
    : undefined

console.log({ references })
---

{
  Component && (
    <Component
      cards={pages || records || children || references}
      pages={pages || records || children || references}
      {...rest}
    />
  )
}
